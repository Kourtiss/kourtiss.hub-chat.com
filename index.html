        let username = null;

        // Show the username popup
        document.getElementById('username-popup').style.display = 'block';

        // Set the username
        function setUsername() {
            const usernameInput = document.getElementById('username');
            username = usernameInput.value.trim();

            if (username !== '') {
                document.getElementById('username-popup').style.display = 'none';
                loadMessages();  // Load messages after setting the username
            } else {
                alert('Please enter a valid username!');
            }
        }

        // Load chat messages from Firestore
        async function loadMessages() {
            const messagesSnapshot = await db.collection('messages').orderBy('timestamp').get();
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = ''; // Clear previous messages
            messagesSnapshot.forEach(doc => {
                const message = doc.data();
                const messageElement = document.createElement('p');
                messageElement.innerHTML = `<strong>${message.name}:</strong> ${message.text}`;
                chatBox.appendChild(messageElement);
            });

            // Scroll to the bottom of the chat box
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Send a new message to Firestore and display it instantly
        async function sendMessage(event) {
            event.preventDefault();
            const messageInput = document.getElementById('message-input');
            const messageText = messageInput.value.trim();

            if (messageText === '') return;

            // Add the message to Firestore
            const newMessage = {
                name: username,
                text: messageText,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            await db.collection('messages').add(newMessage);

            // Display the message instantly
            const chatBox = document.getElementById('chat-box');
            const messageElement = document.createElement('p');
            messageElement.innerHTML = `<strong>${newMessage.name}:</strong> ${newMessage.text}`;
            chatBox.appendChild(messageElement);

            // Scroll to the bottom of the chat box
            chatBox.scrollTop = chatBox.scrollHeight;

            messageInput.value = ''; // Clear input field
        }
